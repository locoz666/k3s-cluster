---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gitlab-runner-amd64
spec:
  maxHistory: 1
  interval: 5m
  timeout: 30m
  install:
    remediation:
      retries: 3
  chart:
    spec:
      # renovate: registryUrl=https://charts.gitlab.io/
      chart: gitlab-runner
      version: 0.85.0
      sourceRef:
        kind: HelmRepository
        name: gitlab
        namespace: flux-system
  values:
    gitlabUrl: "https://git.${SECRET_DOMAIN}"
    rbac:
      create: true
    runners:
      secret: gitlab-runner-amd64
      config: |
        [[runners]]
          [runners.kubernetes]
          image = "ubuntu:22.04"
          [runners.kubernetes.pod_annotations]
            "container.apparmor.security.beta.kubernetes.io/build" = "unconfined"
            "container.apparmor.security.beta.kubernetes.io/helper" = "unconfined"
          [runners.kubernetes.node_selector]
            "node-role.kubernetes.io/gitlab-runner" = ""
            "kubernetes.io/arch" = "amd64"
            "kubernetes.io/os" = "linux"
          [runners.kubernetes.affinity]
            [runners.kubernetes.affinity.node_affinity]
              [[runners.kubernetes.affinity.node_affinity.preferred_during_scheduling_ignored_during_execution]]
                weight = 100
                [runners.kubernetes.affinity.node_affinity.preferred_during_scheduling_ignored_during_execution.preference]
                  [[runners.kubernetes.affinity.node_affinity.preferred_during_scheduling_ignored_during_execution.preference.match_expressions]]
                    key = "kubernetes.io/hostname"
                    operator = "In"
                    values = ["home-server-power"]
              [[runners.kubernetes.affinity.node_affinity.preferred_during_scheduling_ignored_during_execution]]
                weight = 50
                [runners.kubernetes.affinity.node_affinity.preferred_during_scheduling_ignored_during_execution.preference]
                  [[runners.kubernetes.affinity.node_affinity.preferred_during_scheduling_ignored_during_execution.preference.match_expressions]]
                    key = "kubernetes.io/hostname"
                    operator = "In"
                    values = ["home-server-titan"]
              [[runners.kubernetes.affinity.node_affinity.preferred_during_scheduling_ignored_during_execution]]
                weight = 25
                [runners.kubernetes.affinity.node_affinity.preferred_during_scheduling_ignored_during_execution.preference]
                  [[runners.kubernetes.affinity.node_affinity.preferred_during_scheduling_ignored_during_execution.preference.match_expressions]]
                    key = "kubernetes.io/hostname"
                    operator = "In"
                    values = ["home-server-sonic"]
          [runners.cache]
            Type = "s3"
            Path = "gitlab-runner"
            Shared = true
            [runners.cache.s3]
              ServerAddress = "minio-gitlab.${SECRET_DOMAIN}"
              BucketName = "runner-cache"
              BucketLocation = "us-east-1"
              Insecure = false
    nodeSelector:
      node-role.kubernetes.io/gitlab-runner: ""
      kubernetes.io/os: "linux"
      kubernetes.io/arch: "amd64"
