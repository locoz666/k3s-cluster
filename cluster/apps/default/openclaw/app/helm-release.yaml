---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openclaw
spec:
  interval: 5m
  timeout: 30m
  install:
    remediation:
      retries: 3
  chart:
    spec:
      # renovate: registryUrl=https://bjw-s.github.io/helm-charts
      chart: app-template
      version: 4.3.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    controllers:
      main:
        type: deployment
        replicas: 1
        strategy: Recreate
        pod:
          nodeSelector:
            kubernetes.io/hostname: home-server-power
          imagePullSecrets:
            - name: dev-container-registry
        containers:
          openclaw:
            image:
              repository: "registry-gitlab.${SECRET_DOMAIN}/loco/dev-container"
              tag: "f305eca921b060e96e9670797d934862fb80e7c9"
              pullPolicy: Always
            env:
              TZ: "Asia/Shanghai"
              OPENCLAW_CONFIG_PATH: "/root/.openclaw/openclaw.json5"
            command: ["openclaw", "gateway"]
            args:
              - "--port"
              - "18789"
            probes:
              liveness:
                enabled: false
              readiness:
                enabled: false
              startup:
                enabled: false
            resources:
              requests:
                cpu: 10m
                memory: 1Gi
                nvidia.com/gpu: 1
              limits:
                cpu: 24
                memory: 32Gi
                nvidia.com/gpu: 1

    service:
      main:
        enabled: false

    ingress:
      main:
        enabled: false

    persistence:
      dev-share-files:
        existingClaim: dev-share-files
        advancedMounts:
          main:
            openclaw:
              - path: "/mnt/pvc/dev-share-files"
              - path: "/root/code"
                subPath: "code"
              - path: "/root/ai_user_data"
                subPath: "ai_user_data"
              - path: "/root/.bun"
                subPath: "user_data/HOME/.bun"
              - path: "/root/.cache/uv"
                subPath: "user_data/HOME/.cache/uv"
              - path: "/root/.cache/modelscope"
                subPath: "user_data/HOME/.cache/modelscope"
              - path: "/root/.cache/qmd"
                subPath: "HOME/.cache/qmd"
              - path: "/root/.ssh"
                subPath: "user_data/HOME/.ssh"
              - path: "/root/.kube"
                subPath: "user_data/HOME/.kube"
              - path: "/root/.vscode-server"
                subPath: "user_data/HOME/.vscode-server"
              - path: "/root/.zed_server"
                subPath: "user_data/HOME/.zed_server"
              - path: "/root/.config/glab-cli"
                subPath: "user_data/HOME/.config/glab-cli"
              - path: "/root/.config/gh"
                subPath: "user_data/HOME/.config/gh"
              - path: "/root/.happy"
                subPath: "user_data/HOME/.happy"
              - path: "/root/.codex"
                subPath: "user_data/HOME/.codex"
              - path: "/root/.qwen"
                subPath: "user_data/HOME/.qwen"
              - path: "/root/.gemini"
                subPath: "user_data/HOME/.gemini"
              - path: "/root/.code"
                subPath: "user_data/HOME/.code"
              - path: "/root/.claude"
                subPath: "user_data/HOME/.claude"
              - path: "/root/.claude.json"
                subPath: "user_data/HOME/.claude.json"
              - path: "/root/.config/opencode"
                subPath: "user_data/HOME/.config/opencode"
              - path: "/root/.local/share/opencode"
                subPath: "user_data/HOME/.local/share/opencode"
              - path: "/root/.config/opencode/skills"
                subPath: "ai_user_data/skills"
              - path: "/root/.kimi"
                subPath: "user_data/HOME/.kimi"
              - path: "/root/.openclaw"
                subPath: "user_data/HOME/.openclaw"
              - path: "/root/.acpx"
                subPath: "user_data/HOME/.acpx"
              - path: "/root/clawd"
                subPath: "user_data/HOME/clawd"
              - path: "/tmp/clawdbot"
                subPath: "user_data/tmp"
              - path: "/root/clawd/skills"
                subPath: "ai_user_data/skills"

      other-files:
        existingClaim: "other-files"
        advancedMounts:
          main:
            openclaw:
              - path: "/mnt/pvc/other-files"
      personal-files:
        existingClaim: "personal-files"
        advancedMounts:
          main:
            openclaw:
              - path: "/mnt/pvc/personal-files"
      entertainment-media-ec-files:
        existingClaim: "entertainment-media-ec-files"
        advancedMounts:
          main:
            openclaw:
              - path: "/mnt/pvc/entertainment-media-ec-files"
      live-record-ec-files:
        existingClaim: "live-record-ec-files"
        advancedMounts:
          main:
            openclaw:
              - path: "/mnt/pvc/live-record-ec-files"
      entertainment-media-files:
        existingClaim: "entertainment-media-files"
        advancedMounts:
          main:
            openclaw:
              - path: "/mnt/pvc/entertainment-media-files"
      live-record-files:
        existingClaim: "live-record-files"
        advancedMounts:
          main:
            openclaw:
              - path: "/mnt/pvc/live-record-files"
      personal-media-files:
        existingClaim: "personal-media-files"
        advancedMounts:
          main:
            openclaw:
              - path: "/mnt/pvc/personal-media-files"
