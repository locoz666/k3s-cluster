---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: mobileraker-companion
spec:
  maxHistory: 1
  interval: 5m
  timeout: 30m
  install:
    remediation:
      retries: 3
  chart:
    spec:
      # renovate: registryUrl=https://bjw-s.github.io/helm-charts
      chart: app-template
      version: 3.2.1
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    defaultPodOptions:
      terminationGracePeriodSeconds: 1
      automountServiceAccountToken: false
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"

    controllers:
      main:
        type: deployment
        replicas: 1
        containers:
          &main_container mobileraker-companion:
            image:
              repository: "ghcr.io/clon1998/mobileraker_companion"
              tag: "latest@sha256:d1cb86f52cb3d2f839fd99d1f3188d64f3b819bc17a65d5fbedd3ce73e1ec6fe"
            env:
              TZ: "Asia/Shanghai"

    configMaps:
      config:
        data:
          mobileraker.conf: |
            [printer voron2]
            moonraker_uri: ws://klipper-voron2:7125/websocket
            moonraker_api_key: False        

    persistence:
      config:
        type: configMap
        name: "{{ .Release.Name }}-config"
        advancedMounts:
          main:
            *main_container :
              - path: "/opt/printer_data/config/mobileraker.conf"
                readOnly: true
                subPath: "mobileraker.conf"
