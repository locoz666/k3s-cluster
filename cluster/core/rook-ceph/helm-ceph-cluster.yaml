---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: rook-ceph-cluster
  namespace: rook-ceph
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://charts.rook.io/release
      chart: rook-ceph-cluster
      version: v1.7.1
      sourceRef:
        kind: HelmRepository
        name: rook-ceph-charts
        namespace: flux-system
  values:
    operatorNamespace: rook-ceph

    # 设置默认的存储池副本数和最小副本数，以免无副本存储池无法工作
    # 不让mon报存储池无副本的warning
    configOverride: |
      [global]
      mon_allow_pool_delete = true
      osd_pool_default_size = 1
      osd_pool_default_min_size = 1
      [mon]
      mon_warn_on_pool_no_redundancy = false

    toolbox:
      enabled: true

    cephClusterSpec:
      mon:
        # 允许在同一个节点上运行多个mon
        allowMultiplePerNode: true

      # 将所有ceph集群服务设置为必须在有ceph角色的节点上运行
      placement:
        all:
          nodeAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              nodeSelectorTerms:
                - matchExpressions:
                    - key: node-role.kubernetes.io/ceph
                      operator: Exists

      storage:
        # 关闭自动在所有节点和所有磁盘上寻找空白盘并添加为OSD的操作，改为手动配置方式添加
        useAllNodes: false
        useAllDevices: false
        nodes:
          - name: "home-server-nut"
            config:
              # 在 SSD 上划分出 HDD 1% 大小的 BlueStore Database 空间，以提升速度
              metadataDevice: "sdc"
            devices:
              - name: "/dev/disk/by-id/nvme-INTEL_SSDPED1D480GA_PHMB746300LC480DGN"
                config:
                  deviceClass: "nvme"
                  databaseSizeMB: "0"
                  walSizeMB: "0"

              - name: "/dev/disk/by-id/scsi-SATA_ST6000NM0115-1YZ_ZAD71JSA"
                config:
                  deviceClass: "hdd"
                  databaseSizeMB: "60000"  # 60GB

              - name: "/dev/disk/by-id/scsi-SATA_ST6000NM0115-1YZ_ZAD41FWR"
                config:
                  deviceClass: "hdd"
                  databaseSizeMB: "60000"  # 60GB

    ingress:
      dashboard:
        annotations:
          kubernetes.io/ingress.class: "traefik"
          kubernetes.io/tls-acme: "true"
        host:
          name: "ceph.${SECRET_DOMAIN}"
        tls:
          - hosts:
              - "ceph.${SECRET_DOMAIN}"
            secretName: ceph-dashboard-tls

    cephBlockPools:
      - name: ceph-blockpool-nvme-no-compression
        spec:
          failureDomain: osd
          replicated:
            size: 1
            requireSafeReplicaSize: false
          deviceClass: nvme  # 设置后端osd类型

        storageClass:
          enabled: true
          name: ceph-block-nvme-no-compression  # 存储类名称
          isDefault: false  # 设为默认存储类
          reclaimPolicy: Delete  # PVC被删除后自动删除池中的内容
          allowVolumeExpansion: true  # 支持动态调整PVC大小

          parameters:
            # 默认设置不用动
            imageFormat: "2"
            imageFeatures: layering
            csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner
            csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph
            csi.storage.k8s.io/controller-expand-secret-name: rook-csi-rbd-provisioner
            csi.storage.k8s.io/controller-expand-secret-namespace: rook-ceph
            csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node
            csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph
            csi.storage.k8s.io/fstype: ext4  # 可以设置为xfs，但官方不推荐

      - name: ceph-blockpool-nvme-compression
        spec:
          failureDomain: osd
          replicated:
            size: 1
            requireSafeReplicaSize: false
          deviceClass: nvme  # 设置后端osd类型
          parameters:
            compression_mode: aggressive  # 对所有未标注不压缩的数据都进行压缩
            compression_algorithm: zlib  # 使用zlib压缩算法对数据进行压缩，以确保尽可能高的压缩率和还行的速度

        storageClass:
          enabled: true
          name: ceph-block-nvme-compression  # 存储类名称
          isDefault: false  # 设为默认存储类
          reclaimPolicy: Delete  # PVC被删除后自动删除池中的内容
          allowVolumeExpansion: true  # 支持动态调整PVC大小

          parameters:
            # 默认设置不用动
            imageFormat: "2"
            imageFeatures: layering
            csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner
            csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph
            csi.storage.k8s.io/controller-expand-secret-name: rook-csi-rbd-provisioner
            csi.storage.k8s.io/controller-expand-secret-namespace: rook-ceph
            csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node
            csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph
            csi.storage.k8s.io/fstype: ext4  # 可以设置为xfs，但官方不推荐

      - name: ceph-blockpool-hdd-no-compression
        spec:
          failureDomain: osd
          replicated:
            size: 1
            requireSafeReplicaSize: false
          deviceClass: hdd  # 设置后端osd类型

        storageClass:
          enabled: true
          name: ceph-block-hdd-no-compression  # 存储类名称
          isDefault: false  # 设为默认存储类
          reclaimPolicy: Delete  # PVC被删除后自动删除池中的内容
          allowVolumeExpansion: true  # 支持动态调整PVC大小

          parameters:
            # 默认设置不用动
            imageFormat: "2"
            imageFeatures: layering
            csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner
            csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph
            csi.storage.k8s.io/controller-expand-secret-name: rook-csi-rbd-provisioner
            csi.storage.k8s.io/controller-expand-secret-namespace: rook-ceph
            csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node
            csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph
            csi.storage.k8s.io/fstype: ext4  # 可以设置为xfs，但官方不推荐

      - name: ceph-blockpool-hdd-compression
        spec:
          failureDomain: osd
          replicated:
            size: 1
            requireSafeReplicaSize: false
          deviceClass: hdd  # 设置后端osd类型
          parameters:
            compression_mode: aggressive  # 对所有未标注不压缩的数据都进行压缩
            compression_algorithm: zlib  # 使用zlib压缩算法对数据进行压缩，以确保尽可能高的压缩率和还行的速度

        storageClass:
          enabled: true
          name: ceph-block-hdd-compression  # 存储类名称
          isDefault: false  # 设为默认存储类
          reclaimPolicy: Delete  # PVC被删除后自动删除池中的内容
          allowVolumeExpansion: true  # 支持动态调整PVC大小

          parameters:
            # 默认设置不用动
            imageFormat: "2"
            imageFeatures: layering
            csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner
            csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph
            csi.storage.k8s.io/controller-expand-secret-name: rook-csi-rbd-provisioner
            csi.storage.k8s.io/controller-expand-secret-namespace: rook-ceph
            csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node
            csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph
            csi.storage.k8s.io/fstype: ext4  # 可以设置为xfs，但官方不推荐


    cephFileSystems: [ ]
    cephObjectStores: [ ]
